name: evpn_multi-site
prefix: "" 
topology:
  kinds:
    ceos:
      image: ceos:4.34.2F
  nodes:
    DC1_spine1:
      kind: ceos
      startup-config: "configs/DC1/spine1.cfg"
    DC1_spine2:
      kind: ceos
      startup-config: "configs/DC1/spine2.cfg"
    DC1_leaf1:
      kind: ceos
      startup-config: "configs/DC1/leaf1.cfg"
    DC1_leaf2:
      kind: ceos
      startup-config: "configs/DC1/leaf2.cfg"
    DC1_borderleaf:
      kind: ceos
      startup-config: "configs/DC1/borderleaf.cfg"
    DC1_ext-router:
      kind: linux
      image: frrouting/frr:latest
      cap-add:
        - "NET_ADMIN"
        - "SYS_ADMIN"
      binds:
        - configs/ext-router/startup.sh:/etc/frr/startup.sh

    DC2_spine1:
      kind: ceos
      startup-config: "configs/DC2/spine1.cfg"
    DC2_spine2:
      kind: ceos
      startup-config: "configs/DC2/spine2.cfg"
    DC2_leaf1:
      kind: ceos
      startup-config: "configs/DC2/leaf1.cfg"
    DC2_leaf2:
      kind: ceos
      startup-config: "configs/DC2/leaf2.cfg"
    DC2_borderleaf:
      kind: ceos
      startup-config: "configs/DC2/borderleaf.cfg"
    DC2_ext-router:
      kind: linux
      image: frrouting/frr:latest
      cap-add:
        - "NET_ADMIN"
        - "SYS_ADMIN"
      binds:
        - configs/ext-router/startup.sh:/etc/frr/startup.sh
    
    # DC1 Host
    host1:
      kind: ceos
      startup-config: "configs/host1/host1.cfg"
      binds:
        - configs/host1/ceos-config:/mnt/flash/ceos-config
    host2:
      kind: ceos
      startup-config: "configs/host2/host2.cfg"
      binds:
        - configs/host2/ceos-config:/mnt/flash/ceos-config
    host3:
      kind: ceos
      startup-config: "configs/host3/host3.cfg"
      binds:
        - configs/host3/ceos-config:/mnt/flash/ceos-config
    host4:
      kind: ceos
      startup-config: "configs/host4/host4.cfg"
      binds:
        - configs/host4/ceos-config:/mnt/flash/ceos-config
    # DC2 Host
    host5:
      kind: ceos
      startup-config: "configs/host5/host5.cfg"
      binds:
        - configs/host5/ceos-config:/mnt/flash/ceos-config
    host6:
      kind: ceos
      startup-config: "configs/host6/host6.cfg"
      binds:
        - configs/host6/ceos-config:/mnt/flash/ceos-config
    host7:
      kind: ceos
      startup-config: "configs/host7/host7.cfg"
      binds:
        - configs/host7/ceos-config:/mnt/flash/ceos-config
    host8:
      kind: ceos
      startup-config: "configs/host8/host8.cfg"
      binds:
        - configs/host8/ceos-config:/mnt/flash/ceos-config

    wan-router1:
      kind: ceos
      startup-config: "configs/wan-router1.cfg"
    wan-router2:
      kind: ceos
      startup-config: "configs/wan-router2.cfg"

links:
    # --- DC1: 내부 Spine-Leaf 연결 ---
    - endpoints: ["DC1_spine1:eth2", "DC1_leaf1:eth1"]
    - endpoints: ["DC1_spine1:eth3", "DC1_leaf2:eth1"]
    - endpoints: ["DC1_spine1:eth4", "DC1_borderleaf:eth1"]

    - endpoints: ["DC1_spine2:eth2", "DC1_leaf1:eth2"]
    - endpoints: ["DC1_spine2:eth3", "DC1_leaf2:eth2"]
    - endpoints: ["DC1_spine2:eth4", "DC1_borderleaf:eth2"]

    # --- DC2: 내부 Spine-Leaf 연결 ---
    - endpoints: ["DC2_spine1:eth2", "DC2_leaf1:eth1"]
    - endpoints: ["DC2_spine1:eth3", "DC2_leaf2:eth1"]
    - endpoints: ["DC2_spine1:eth4", "DC2_borderleaf:eth1"]

    - endpoints: ["DC2_spine2:eth2", "DC2_leaf1:eth2"]
    - endpoints: ["DC2_spine2:eth3", "DC2_leaf2:eth2"]
    - endpoints: ["DC2_spine2:eth4", "DC2_borderleaf:eth2"]

    # --- DC1: 호스트 연결 ---
    - endpoints: ["DC1_leaf1:eth3", "host1:eth1"]
    - endpoints: ["DC1_leaf1:eth4", "host2:eth1"]
    - endpoints: ["DC1_leaf2:eth3", "host3:eth1"]
    - endpoints: ["DC1_leaf2:eth4", "host4:eth1"]

    # --- DC2: 호스트 연결 ---
    - endpoints: ["DC2_leaf1:eth3", "host5:eth1"]
    - endpoints: ["DC2_leaf1:eth4", "host6:eth1"]
    - endpoints: ["DC2_leaf2:eth3", "host7:eth1"]
    - endpoints: ["DC2_leaf2:eth4", "host8:eth1"]

    # --- DCI: WAN 구간 연결 (BorderLeaf <-> WAN Routers) ---
    - endpoints: ["DC1_borderleaf:eth5", "wan-router1:eth1"]
    - endpoints: ["DC1_borderleaf:eth6", "wan-router2:eth1"]
    
    - endpoints: ["DC2_borderleaf:eth5", "wan-router1:eth2"]
    - endpoints: ["DC2_borderleaf:eth6", "wan-router2:eth2"]

    # --- Internet: 외부 NAT 라우터 연결 (Local Breakout) ---
    - endpoints: ["DC1_borderleaf:eth7", "DC1_ext-router:eth1"]
    - endpoints: ["DC2_borderleaf:eth7", "DC2_ext-router:eth1"]

# clab deploy -t evpn_L3VPN-multi_External.yaml
# clab inspect -t evpn_L3VPN-multi_External.yaml
# clab graph -t evpn_L3VPN-multi_External.yaml
# clab destroy -t evpn_L3VPN-multi_External.yaml : 작성한 토폴로지 제거 → node 설정 파일(startup config) 유지
# clab destroy -ac evpn_L3VPN-multi_External.yaml : 토폴로지 완전 초기화

# ======== ext-router 초기 세팅 ==========
# 1. ext-router 콘솔 접속
# docker exec -it ext-router bash

# 2. startup.sh 실행 및 IP 설정 확인(eth1::내부 / eth0::외부)
# /etc/frr/startup.sh
# ip a show eth0
# ip a show eth1
# ip a show eth2

# apk update
# apk add tcpdump

# tcpdump -i eth1 -n icmp