name: vxlan_L3VPN_External
prefix: "" 
topology:
  kinds:
    ceos:
      image: ceos:4.34.2F
  nodes:
    spine1:
      kind: ceos
      startup-config: "configs/spine1.cfg"
    spine2:
      kind: ceos
      startup-config: "configs/spine2.cfg"
    leaf1:
      kind: ceos
      startup-config: "configs/leaf1.cfg"
    leaf2:
      kind: ceos
      startup-config: "configs/leaf2.cfg"
    leaf3:
      kind: ceos
      startup-config: "configs/leaf3.cfg"
    borderleaf:
      kind: ceos
      startup-config: "configs/borderleaf.cfg"
    host1:
      kind: ceos
      startup-config: "configs/host1/host1.cfg"
      binds:
        - configs/host1/ceos-config:/mnt/flash/ceos-config
    host2:
      kind: ceos
      startup-config: "configs/host2/host2.cfg"
      binds:
        - configs/host2/ceos-config:/mnt/flash/ceos-config
    host3:
      kind: ceos
      startup-config: "configs/host3/host3.cfg"
      binds:
        - configs/host3/ceos-config:/mnt/flash/ceos-config
    host4:
      kind: ceos
      startup-config: "configs/host4/host4.cfg"
      binds:
        - configs/host4/ceos-config:/mnt/flash/ceos-config
    ext-router:
      kind: linux
      image: frrouting/frr:latest
      cap-add:
        - "NET_ADMIN"   # iptables NAT 설정을 위한 권한
        - "SYS_ADMIN"   # sysctl (IP 포워딩) 설정을 위한 권한
      binds:
        - configs/ext-router/startup.sh:/etc/frr/startup.sh
      # 컨테이너가 시작될 때 startup.sh를 먼저 실행하고,
      # 그 다음 FRR의 기본 프로세스(/sbin/docker-init)를 실행
      # cmd: sh -c "/etc/frr/startup.sh && /sbin/docker-init"
  links:
    # --- Spine-Leaf 링크 ---
    - endpoints: ["spine1:eth2", "leaf1:eth1"]
    - endpoints: ["spine1:eth3", "leaf2:eth1"]
    - endpoints: ["spine1:eth4", "leaf3:eth1"]
    - endpoints: ["spine2:eth2", "leaf1:eth2"]
    - endpoints: ["spine2:eth3", "leaf2:eth2"]
    - endpoints: ["spine2:eth4", "leaf3:eth2"]
    # --- 신규 Spine-BorderLeaf 링크 추가 ---
    - endpoints: ["spine1:eth5", "borderleaf:eth1"]
    - endpoints: ["spine2:eth5", "borderleaf:eth2"]
    # --- Leaf-Host 링크 ---
    - endpoints: ["leaf1:eth3", "host1:eth1"]
    - endpoints: ["leaf1:eth4", "host2:eth1"]
    - endpoints: ["leaf2:eth3", "host3:eth1"]
    - endpoints: ["leaf3:eth3", "host4:eth1"]
    # --- 신규 BorderLeaf-External 라우터 링크 ---
    - endpoints: ["borderleaf:eth5", "ext-router:eth1"]
    
# clab deploy -t vxlan_L3VPN_External.yaml
# clab inspect -t vxlan_L3VPN_External.yaml
# clab graph -t vxlan_L3VPN_External.yaml
# clab destroy -t vxlan_L3VPN_External.yaml : 작성한 토폴로지 제거 → node 설정 파일(startup config) 유지
# clab destroy -ac vxlan_L3VPN_External.yaml : 토폴로지 완전 초기화

# ======== ext-router 초기 세팅 ==========
# 1. ext-router 콘솔 접속
# docker exec -it ext-router bash

# 2. startup.sh 실행 및 IP 설정 확인(eth1::내부 / eth0::외부)
# /etc/frr/startup.sh
# ip a show eth0
# ip a show eth1

# apk update
# apk add tcpdump

# tcpdump -i eth1 -n icmp